<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cart Simulation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <script>
        let activeTextarea = null;

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll("textarea").forEach(el => {
                el.addEventListener("focus", () => {
                    activeTextarea = el;
                });
            });
        });

        function insertAtCursor(text) {
            if (!activeTextarea) return;

            const start = activeTextarea.selectionStart;
            const end = activeTextarea.selectionEnd;
            const value = activeTextarea.value;
            if (value.length === 0) {
                activeTextarea.value = text;
                activeTextarea.selectionStart = activeTextarea.selectionEnd = text.length;
                activeTextarea.focus();
                return;
            }

            const lineEnd = value.indexOf("\n", start);
            const insertPos = lineEnd === -1 ? value.length : lineEnd + 1;
            const needsLeadingNewline = insertPos > 0 && value[insertPos - 1] !== "\n";
            const insertText = (needsLeadingNewline ? "\n" : "") + text;

            activeTextarea.value = value.substring(0, insertPos) + insertText + value.substring(insertPos);
            const newCursor = insertPos + insertText.length;
            activeTextarea.selectionStart = activeTextarea.selectionEnd = newCursor;
            activeTextarea.focus();
        }

        function replaceTypePlaceholder(typeValue) {
            if (!activeTextarea) {
                activeTextarea = document.getElementById("discount_text_a");
            }

            const value = activeTextarea.value;
            const cursor = activeTextarea.selectionStart;
            const lineStart = value.lastIndexOf("\n", cursor - 1) + 1;
            const lineEnd = value.indexOf("\n", cursor);
            const endPos = lineEnd === -1 ? value.length : lineEnd;
            const line = value.substring(lineStart, endPos);

            const colonIdx = line.indexOf(":");
            if (colonIdx === -1) return;

            const verb = line.substring(0, colonIdx).trim();
            const argsText = line.substring(colonIdx + 1);
            const typeArgMap = {
                type_discount: [0],
                bogo: [0],
                type_tier_discount: [0],
                buy_type_get_type_discount: [0, 1],
                free_shipping_type_qty: [0],
            };
            const typeIndexes = typeArgMap[verb];
            if (!typeIndexes) return;

            const args = argsText.split(",");
            const cursorInArgs = cursor - lineStart - (colonIdx + 1);
            let targetIndex = typeIndexes[0];

            let running = 0;
            for (let i = 0; i < args.length; i++) {
                const argLen = args[i].length;
                const start = running;
                const end = running + argLen;
                if (cursorInArgs >= start && cursorInArgs <= end) {
                    if (typeIndexes.includes(i)) {
                        targetIndex = i;
                    }
                    break;
                }
                running = end + 1; // +1 for comma
            }

            if (args[targetIndex] === undefined) return;
            const match = args[targetIndex].match(/^(\s*)(.*?)(\s*)$/);
            const lead = match ? match[1] : "";
            const trail = match ? match[3] : "";
            args[targetIndex] = `${lead}${typeValue}${trail}`;
            const updatedLine = line.substring(0, colonIdx + 1) + args.join(",");

            activeTextarea.value = value.substring(0, lineStart) + updatedLine + value.substring(endPos);
            const newCursor = lineStart + updatedLine.length;
            activeTextarea.selectionStart = activeTextarea.selectionEnd = newCursor;
            activeTextarea.focus();
        }
    </script>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <a class="brand" href="/">Cart Simulation Studio</a>
            <p class="subtitle">Compare discount strategies with a clean, shared look.</p>
        </div>
    </header>

    <main class="container">
        <form method="POST">
            <section class="card">
                <div class="toolbar">
                    <div>
                        <h1>Cart Simulator</h1>
                        <p class="muted">Adjust quantities, apply discount rules, and compare A vs B.</p>
                    </div>
                    <div class="actions">
                        <a class="btn secondary" href="/edit-products">Edit Product Data</a>
                        <button class="btn secondary" type="submit" name="action" value="save_prices">Save Prices</button>
                        <button class="btn" type="submit" name="action" value="simulate">Simulate Cart(s)</button>
                    </div>
                </div>
            </section>

            <div class="layout-split">
                <section class="card compact-card">
                    <div class="section-title">
                        <h2>Products</h2>
                        <span class="muted">Quick cart builder</span>
                    </div>
                    <div class="table-scroll">
                        <table class="data-table compact-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Ship</th>
                                    <th>Qty</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, item in products.items() %}
                                <tr class="product-row" data-type="{{ item.type }}" onclick="replaceTypePlaceholder('{{ item.type }}')">
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.type }}</td>
                                    <td>
                                        <input class="price-input" type="text" name="price_{{ key }}"
                                               value="{{ "%.2f"|format(item.price) }}" inputmode="decimal"
                                               onclick="event.stopPropagation()" />
                                    </td>
                                    <td>${{ "%.2f"|format(item.store_shipping) }}</td>
                                    <td><input class="qty-input" type="number" name="qty_{{ key }}" min="0"
                                               value="{{ cart[key] if key in cart else 0 }}" onclick="event.stopPropagation()" /></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="card">
                    <h2>Discount Verbs</h2>
                    <p class="muted">Click to insert a template into the active discount textarea.</p>
                    <div>
                        <span class="discount-verb" onclick="insertAtCursor('whole_order:x')">whole_order</span>
                        <span class="discount-verb" onclick="insertAtCursor('type_discount:prod_type_1,10')">type_discount</span>
                        <span class="discount-verb" onclick="insertAtCursor('min_total:total=percent')">min_total</span>
                        <span class="discount-verb" onclick="insertAtCursor('free_shipping:total')">free_shipping</span>
                        <span class="discount-verb" onclick="insertAtCursor('free_shipping_type_qty: prod_type_1, 3')">free_shipping_type_qty</span>
                        <span class="discount-verb" onclick="insertAtCursor('bogo:prod_type_1,buy_qty,free_qty')">bogo</span>
                        <span class="discount-verb" onclick="insertAtCursor('buy_x_get_1off:3,50')">buy_x_get_1off</span>
                        <span class="discount-verb" onclick="insertAtCursor('type_tier_discount: prod_type_1, 3=3, 5=5')">type_tier_discount</span>
                        <span class="discount-verb" onclick="insertAtCursor('buy_type_get_type_discount: prod_type_1, prod_type_2, 15')">buy_type_get_type_discount</span>
                        <span class="discount-verb" onclick="insertAtCursor('cart_quantity_discount: 5,10')">cart_quantity_discount</span>
                </div>

                    <div class="grid-2" style="margin-top: 16px;">
                        <div>
                            <label for="discount_text_a"><strong>Discount Command(s) A</strong></label>
                            <textarea id="discount_text_a" name="discount_text_a" rows="4">{{ discount_text_a }}</textarea>
                            <button class="btn secondary" type="button" onclick="document.getElementById('discount_text_a').value = ''">Clear</button>
                        </div>
                        <div>
                            <label for="discount_text_b"><strong>Discount Command(s) B</strong></label>
                            <textarea id="discount_text_b" name="discount_text_b" rows="4">{{ discount_text_b }}</textarea>
                            <button class="btn secondary" type="button" onclick="document.getElementById('discount_text_b').value = ''">Clear</button>
                        </div>
                    </div>
                </section>
            </div>
        </form>

        {% if result_a and result_b %}
        <section class="card">
            <h2>Simulation Comparison</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Discount A</th>
                        <th>Discount B</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td><strong>Original Price</strong></td>
                        <td>${{ "%.2f"|format(result_a.original_price) }} USD</td>
                        <td>${{ "%.2f"|format(result_b.original_price) }} USD</td></tr>

                    <tr>
                      <td><strong>Total Discount</strong></td>
                      <td>
                        ${{ "%.2f"|format(result_a.total_discount_incl_shipping) }} USD
                        <ul style="margin:6px 0 0 18px;">
                          {% for d in result_a.discount_breakdown %}
                          <li>[M] {{ d.label }}: ${{ "%.2f"|format(d.amount) }} USD</li>
                          {% endfor %}
                          {% for d in result_a.shipping_discount_breakdown %}
                          <li>[S] {{ d.label }}: ${{ "%.2f"|format(d.amount) }} USD</li>
                          {% endfor %}
                        </ul>
                      </td>
                      <td>
                        ${{ "%.2f"|format(result_b.total_discount_incl_shipping) }} USD
                        <ul style="margin:6px 0 0 18px;">
                          {% for d in result_b.discount_breakdown %}
                          <li>[M] {{ d.label }}: ${{ "%.2f"|format(d.amount) }} USD</li>
                          {% endfor %}
                          {% for d in result_b.shipping_discount_breakdown %}
                          <li>[S] {{ d.label }}: ${{ "%.2f"|format(d.amount) }} USD</li>
                          {% endfor %}
                        </ul>
                      </td>
                    </tr>

                    <tr><td><strong>Order Total (after discounts)</strong></td>
                        <td>${{ "%.2f"|format(result_a.order_total) }} USD ({{ "%.2f"|format(result_a.order_total * result_a.exchange_rate) }} CAD)</td>
                        <td>${{ "%.2f"|format(result_b.order_total) }} USD ({{ "%.2f"|format(result_b.order_total * result_b.exchange_rate) }} CAD)</td></tr>

                    <tr><td><strong>Store Shipping Charged</strong></td>
                        <td>${{ "%.2f"|format(result_a.store_shipping_total - result_a.store_shipping_discount) }} USD</td>
                        <td>${{ "%.2f"|format(result_b.store_shipping_total - result_b.store_shipping_discount) }} USD</td></tr>

                    <tr style="background: #e6f7f5"><td><strong>Customer Pays</strong></td>
                        <td>${{ "%.2f"|format(result_a.customer_total) }} USD ({{ "%.2f"|format(result_a.order_value_cad) }} CAD) ->
                            {% set denom = result_a.original_price + result_a.store_shipping_total %}
                            {% if denom > 0 %}
                                {{ "%.2f"|format((1 - (result_a.customer_total / denom)) * 100) }}% OFF
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(result_b.customer_total) }} USD ({{ "%.2f"|format(result_b.order_value_cad) }} CAD)->
                            {% set denom = result_b.original_price + result_b.store_shipping_total %}
                            {% if denom > 0 %}
                                {{ "%.2f"|format((1 - (result_b.customer_total / denom)) * 100) }}% OFF
                            {% else %}
                                -
                            {% endif %}
                        </td></tr>

                    <tr><td><strong>COGS</strong></td>
                        <td>
                          <details>
                            <summary>${{ "%.2f"|format(result_a.total_cogs) }} USD ({{ "%.2f"|format(result_a.total_cogs * result_a.exchange_rate) }} CAD)</summary>
                            <ul style="margin:6px 0 0 18px;">
                              {% for item in result_a.cogs_breakdown %}
                              <li>{{ item.name }} ({{ item.type }}) × {{ item.qty }} — ${{ "%.2f"|format(item.total_cogs) }} USD</li>
                              {% endfor %}
                            </ul>
                          </details>
                        </td>
                        <td>
                          <details>
                            <summary>${{ "%.2f"|format(result_b.total_cogs) }} USD ({{ "%.2f"|format(result_b.total_cogs * result_b.exchange_rate) }} CAD)</summary>
                            <ul style="margin:6px 0 0 18px;">
                              {% for item in result_b.cogs_breakdown %}
                              <li>{{ item.name }} ({{ item.type }}) × {{ item.qty }} — ${{ "%.2f"|format(item.total_cogs) }} USD</li>
                              {% endfor %}
                            </ul>
                          </details>
                        </td></tr>

                    <tr><td><strong>Real Shipping Cost</strong></td>
                        <td>${{ "%.2f"|format(result_a.real_shipping_total) }} USD ({{ "%.2f"|format(result_a.real_shipping_total * result_a.exchange_rate) }} CAD)</td>
                        <td>${{ "%.2f"|format(result_b.real_shipping_total) }} USD ({{ "%.2f"|format(result_b.real_shipping_total * result_b.exchange_rate) }} CAD)</td></tr>

                    <tr><td><strong>COGS Tax (7%)</strong></td>
                        <td>${{ "%.2f"|format(result_a.cogs_tax) }} USD ({{ "%.2f"|format(result_a.cogs_tax * result_a.exchange_rate) }} CAD)</td>
                        <td>${{ "%.2f"|format(result_b.cogs_tax) }} USD ({{ "%.2f"|format(result_b.cogs_tax * result_b.exchange_rate) }} CAD)</td></tr>

                    <tr style="border: 3px solid #f97316;"><td><strong>COGS Total (and %)</strong></td>
                        <td>{{ "%.2f"|format(result_a.total_cogs + result_a.real_shipping_total + result_a.cogs_tax) }} USD
                            {% set denom = result_a.customer_total %}
                            {% if denom > 0 %}
                                (@ {{ "%.2f"|format((result_a.total_cogs + result_a.real_shipping_total + result_a.cogs_tax)/result_a.customer_total*100) }}%)
                            {% else %}
                                -
                            {% endif %}
                            </td>
                        <td>{{ "%.2f"|format(result_b.total_cogs + result_b.real_shipping_total + result_b.cogs_tax) }} USD
                            {% set denom = result_b.customer_total %}
                            {% if denom > 0 %}
                                (@ {{ "%.2f"|format((result_b.total_cogs + result_b.real_shipping_total + result_b.cogs_tax)/result_b.customer_total*100) }}%)
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>

                    <tr><td><strong>Store Fees</strong></td>
                        <td>{{ "%.2f"|format(result_a.store_fee_cad) }} CAD</td>
                        <td>{{ "%.2f"|format(result_b.store_fee_cad) }} CAD</td></tr>

                    <tr><td><strong>Store Payout</strong></td>
                    <td>{{ "%.2f"|format(result_a.store_payout_cad) }} CAD</td>
                    <td>{{ "%.2f"|format(result_b.store_payout_cad) }} CAD</td></tr>

                    <tr><td><strong>Total Cost</strong></td>
                    <td>{{ "%.2f"|format(result_a.total_expenses_cad) }} CAD</td>
                    <td>{{ "%.2f"|format(result_b.total_expenses_cad) }} CAD</td></tr>


                    <tr style="border: 3px solid #10b981;"><td><strong>Profit/Loss in CAD (margin)</strong></td>
                        <td><strong>{{ "%.2f"|format(result_a.profit_cad) }}
                            {% if result_a.order_value_cad > 0 %}
                              ({{ "%.2f"|format(result_a.profit_cad/result_a.order_value_cad*100) }}%)
                            {% else %}
                              (-)
                            {% endif %}
                            </strong> CAD</td>
                        <td><strong>{{ "%.2f"|format(result_b.profit_cad) }}
                            {% if result_b.order_value_cad > 0 %}
                              ({{ "%.2f"|format(result_b.profit_cad/result_b.order_value_cad*100) }}%)
                            {% else %}
                              (-)
                            {% endif %}
                            </strong> CAD</td>
                    </tr>
                </tbody>
            </table>
        </section>
        {% endif %}
    </main>
</body>
</html>
